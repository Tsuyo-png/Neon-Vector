<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neon Vector | 7.2.2 Stable Fixed</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --c-bg: #080808;
            --c-grid: #1a1a1a;
            --c-player: #00ffff;
            --c-ally: #00ff00;
            --c-enemy: #ff0055;
            --c-boss: #ff00ff;
            --c-mega: #ffffff;
            --font-ui: 'Orbitron', sans-serif;
            --font-txt: 'Rajdhani', sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--c-bg); font-family: var(--font-ui);
            touch-action: none; user-select: none; overflow: hidden; position: fixed;
        }

        #gameCanvas { display: block; width: 100%; height: 100%; }
        body.pc-mode { cursor: crosshair; }

        /* UI Base */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* HUD */
        .hud-top {
            position: absolute; top: max(15px, env(safe-area-inset-top)); width: 100%;
            display: flex; justify-content: space-between; padding: 0 4%; box-sizing: border-box;
            color: #fff; text-shadow: 0 0 5px var(--c-player); font-size: clamp(14px, 3vmin, 20px); font-weight: bold;
        }
        .bars-wrap { position: absolute; top: 0; left: 0; width: 100%; }
        .bar { width: 100%; height: 4px; background: #333; }
        #xp-bar { height: 100%; width: 0%; background: #0f0; transition: width 0.2s; }
        #hp-bar { height: 100%; width: 100%; background: #f00; transition: width 0.1s; }

        /* Boss HUD */
        #boss-hud {
            position: absolute; top: 12%; left: 50%; transform: translateX(-50%); width: 60%;
            display: none; flex-direction: column; align-items: center; transition: all 0.3s;
        }
        #boss-name { color: var(--c-boss); font-size: 16px; font-weight: 900; margin-bottom: 4px; letter-spacing: 2px; }
        #boss-hp-bg { width: 100%; height: 12px; background: #300; border: 2px solid var(--c-boss); transform: skewX(-20deg); }
        #boss-hp-fill { width: 100%; height: 100%; background: var(--c-boss); transition: width 0.1s; }
        #boss-hud.mega #boss-name { color: var(--c-mega); text-shadow: 0 0 10px #f00; }
        #boss-hud.mega #boss-hp-bg { border-color: var(--c-mega); }
        #boss-hud.mega #boss-hp-fill { background: var(--c-mega); box-shadow: 0 0 15px #f00; }

        /* Nexus AI */
        #nexus-log {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; text-align: center;
            font-family: var(--font-txt); font-size: 16px; color: var(--c-player);
            text-shadow: 0 0 4px var(--c-player); opacity: 0; transition: opacity 0.5s;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 4px; border: 1px solid rgba(0,255,255,0.3);
        }
        #nexus-log.active { opacity: 1; }

        /* Warning Overlay */
        #warning-overlay {
            position: absolute; top: 40%; left: 0; width: 100%; text-align: center;
            display: none; flex-direction: column; align-items: center;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse { 0%{opacity:1; transform:scale(1);} 50%{opacity:0.5; transform:scale(1.1);} 100%{opacity:1; transform:scale(1);} }
        #warning-text { color: #f00; font-size: clamp(30px, 8vmin, 60px); font-weight: 900; text-shadow: 0 0 20px #f00; }

        /* Controls */
        .joystick-zone { position: absolute; bottom: 40px; width: clamp(140px, 22vmin, 200px); height: clamp(140px, 22vmin, 200px); pointer-events: auto; }
        #stick-left { left: 5%; } #stick-right { right: 5%; }
        .joystick-base { width: 100%; height: 100%; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); }
        .joystick-knob { width: 40%; height: 40%; border-radius: 50%; background: rgba(0, 255, 255, 0.4); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        #shockwave-btn {
            position: absolute; bottom: clamp(180px, 35vmin, 260px); right: 5%;
            width: clamp(60px, 12vmin, 80px); height: clamp(60px, 12vmin, 80px);
            border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid #fff;
            color: #fff; display: flex; justify-content: center; align-items: center;
            font-size: 24px; pointer-events: auto; cursor: pointer;
        }
        #shockwave-btn.cooldown { opacity: 0.3; pointer-events: none; }
        .cd-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); border-radius: 50%; height: 0%; transition: height 0.1s linear; }

        #pc-skill-hud { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; flex-direction: column; align-items: center; }
        #pc-skill-bar { width: 200px; height: 6px; background: #333; }
        #pc-skill-fill { width: 100%; height: 100%; background: var(--c-player); }

        /* Screens */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 100; transition: opacity 0.2s;
        }
        .hidden { display: none !important; opacity: 0; }
        
        h1 { font-size: clamp(50px, 10vmin, 100px); color: transparent; -webkit-text-stroke: 1px var(--c-player); margin: 0; text-shadow: 0 0 20px var(--c-player); }
        .btn {
            margin-top: 20px; padding: 15px 40px; font-size: 20px; font-family: var(--font-ui); font-weight: bold;
            background: transparent; color: var(--c-player); border: 2px solid var(--c-player);
            cursor: pointer; min-width: 200px; text-transform: uppercase;
        }
        .btn:hover { background: rgba(0,255,255,0.1); box-shadow: 0 0 20px rgba(0,255,255,0.4); }
        
        .cards-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px; width: 100%; max-width: 900px;}
        .card {
            width: clamp(140px, 25vmin, 180px); height: clamp(220px, 40vmin, 280px);
            background: linear-gradient(145deg, #111, #222); border: 1px solid #444; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 15px;
            cursor: pointer; position: relative;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--c-player); }
        .card.boss-card { border-color: var(--c-boss); box-shadow: 0 0 15px rgba(255,0,255,0.3); }
        .card h3 { color: var(--c-player); margin: 0; font-size: 16px; text-align: center; }
        .card p { color: #aaa; font-size: 12px; text-align: center; font-family: var(--font-txt); }
        .card .icon { font-size: 40px; }
        .rarity { font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .rare { color: #0f0; } .legendary { color: #ffaa00; } .epic { color: #f0f; }

        .key-hint { display: inline-block; background: #222; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; font-size: 10px; color: #fff; margin: 0 2px; }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer" class="hidden">
    <div class="bars-wrap">
        <div class="bar"><div id="xp-bar"></div></div>
        <div class="bar" style="height:2px; margin-top:2px;"><div id="hp-bar"></div></div>
    </div>
    
    <div id="boss-hud">
        <div id="boss-name">BOSS</div>
        <div id="boss-hp-bg"><div id="boss-hp-fill"></div></div>
    </div>

    <div id="warning-overlay">
        <div id="warning-text">ANOMALY DETECTED</div>
        <p style="color:#fff; letter-spacing:3px;">OMEGA CLASS APPROACHING</p>
    </div>

    <div id="nexus-log"></div>

    <div class="hud-top">
        <div>SCORE: <span id="score-val">0</span></div>
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="wave-val">WAVE 1</span>
            <div id="pause-btn" style="cursor:pointer;">❚❚</div>
        </div>
    </div>

    <div id="stick-left" class="joystick-zone mobile"><div class="joystick-base"><div class="joystick-knob"></div></div></div>
    <div id="shockwave-btn" class="mobile">⚡<div class="cd-overlay" id="shock-cd"></div></div>
    <div id="stick-right" class="joystick-zone mobile"><div class="joystick-base"><div class="joystick-knob"></div></div></div>

    <div id="pc-skill-hud">
        <div id="pc-skill-label">SHOCKWAVE [SPACE]</div>
        <div id="pc-skill-bar"><div id="pc-skill-fill"></div></div>
    </div>
</div>

<div id="start-screen" class="modal">
    <h1>NEON<br>VECTOR</h1>
    <p style="color:#666; margin-top:10px;">VERSION 7.2.2 (RESTORED)</p>
    <div style="color:#ff0; margin-top:20px; font-size:18px;">HIGH SCORE: <span id="high-score">0</span></div>
    <button class="btn" id="btn-start">JOGAR</button>
    <button class="btn" id="btn-full" style="border-color:#f0f; color:#f0f; margin-top:10px;">FULLSCREEN</button>
    <div style="margin-top:30px; font-size:12px; color:#555;" id="ctrl-hint">Detecting...</div>
</div>

<div id="upgrade-screen" class="modal hidden">
    <h2 style="color:#fff; font-size:30px;">SYSTEM UPGRADE</h2>
    <div class="cards-grid" id="cards-wrapper"></div>
</div>

<div id="pause-screen" class="modal hidden">
    <h1 style="font-size:60px;">PAUSED</h1>
    <button class="btn" id="btn-resume">RESUME</button>
    <button class="btn" id="btn-menu" style="border-color:#f00; color:#f00;">EXIT</button>
</div>

<div id="game-over-screen" class="modal hidden">
    <h1 style="color:#f00; -webkit-text-stroke:1px #f00;">K.O.</h1>
    <p style="color:#fff; font-size:20px;" id="final-stats">SCORE: 0</p>
    <div id="nexus-analysis" style="color:var(--c-player); margin-top:10px; font-family:var(--font-txt);"></div>
    <button class="btn" id="btn-restart">RETRY</button>
    <button class="btn" id="btn-menu-over" style="border-color:#888; color:#888; margin-top:10px;">MENU</button>
</div>

<script>
(function() {

// --- 1. CORE CONFIG ---
const CFG = {
    w: 4000,
    colors: {
        bg: '#080808', grid: '#1a1a1a',
        p: '#00ffff', ally: '#00ff00', xp: '#00ff00',
        e_basic: '#ff0055', e_tank: '#ffaa00', e_sniper: '#aa00ff', e_dasher: '#ffff00', e_spinner: '#00ffaa',
        boss: '#ff00ff', mega: '#ffffff'
    }
};

// --- 2. HELPERS ---
class Vec {
    constructor(x, y) { this.x = x; this.y = y; }
    add(v) { this.x+=v.x; this.y+=v.y; return this; }
    sub(v) { this.x-=v.x; this.y-=v.y; return this; }
    mult(n) { this.x*=n; this.y*=n; return this; }
    mag() { return Math.sqrt(this.x*this.x + this.y*this.y); }
    norm() { let m=this.mag(); if(m>0){this.x/=m; this.y/=m;} return this; }
    copy() { return new Vec(this.x, this.y); }
    static dist(v1, v2) { return Math.sqrt((v1.x-v2.x)**2 + (v1.y-v2.y)**2); }
}

const Nexus = {
    log(txt) {
        let el = document.getElementById('nexus-log');
        if(!el) return;
        el.innerText = "NEXUS: " + txt; el.classList.add('active');
        setTimeout(() => el.classList.remove('active'), 4000);
    },
    bossIntro(name, mega) {
        const p = [
            `WARNING: ${name} approaching.`,
            `High energy signal detected.`,
            `Targeting hostile entity: ${name}.`,
            mega ? "CRITICAL: OMEGA CLASS THREAT." : "Boss signature confirmed."
        ];
        this.log(p[Math.floor(Math.random()*p.length)]);
    }
};

// --- 3. INPUT ---
class Joy {
    constructor(id) {
        this.el = document.getElementById(id); this.knob = this.el.querySelector('.joystick-knob');
        this.active = false; this.tid = null; this.vec = new Vec(0,0); this.base={x:0,y:0,r:0};
        const start = (e) => { e.preventDefault(); this.active=true; this.tid=e.changedTouches[0].identifier; this.move(e.changedTouches[0]); };
        const move = (e) => { if(!this.active)return; for(let t of e.changedTouches) if(t.identifier===this.tid) { e.preventDefault(); this.move(t); }};
        const end = (e) => { for(let t of e.changedTouches) if(t.identifier===this.tid) this.reset(); };
        this.el.addEventListener('touchstart', start, {passive:false});
        window.addEventListener('touchmove', move, {passive:false});
        window.addEventListener('touchend', end, {passive:false});
        this.rect(); setInterval(()=>this.rect(),1000);
    }
    rect() { let r = this.el.getBoundingClientRect(); this.base={x:r.left+r.width/2, y:r.top+r.height/2, r:r.width/2}; }
    move(t) {
        let dx = t.clientX - this.base.x, dy = t.clientY - this.base.y;
        let d = Math.sqrt(dx*dx+dy*dy), l = Math.min(d, this.base.r), a = Math.atan2(dy, dx);
        this.vec.x = Math.cos(a)*l/this.base.r; this.vec.y = Math.sin(a)*l/this.base.r;
        this.knob.style.transform = `translate(${this.vec.x*this.base.r}px, ${this.vec.y*this.base.r}px)`;
    }
    reset() { this.active=false; this.vec=new Vec(0,0); this.knob.style.transform='translate(0,0)'; }
}

const Input = {
    keys: {}, m: new Vec(0,0), mDown: false, lStick: null, rStick: null, isPC: true, shockReady: true, locked: false,
    init() {
        this.isPC = !('ontouchstart' in window);
        if(this.isPC) {
            document.querySelectorAll('.mobile').forEach(e=>e.style.display='none');
            document.getElementById('pc-skill-hud').style.display='flex';
            document.getElementById('ctrl-hint').innerHTML = "<span class='key'>WASD</span> Move • <span class='key'>MOUSE</span> Aim • <span class='key'>SPACE</span> Skill";
            document.body.classList.add('pc-mode');
        } else {
            document.getElementById('ctrl-hint').innerText = "Use Joysticks • Tap ⚡ for Skill";
        }
        window.onkeydown = e => { this.keys[e.key.toLowerCase()]=true; if(e.code==='Space') this.skill(); if(e.key==='Escape') Game.pause(); };
        window.onkeyup = e => this.keys[e.key.toLowerCase()]=false;
        window.onblur = () => { this.keys={}; this.mDown=false; }; 
        window.onmousemove = e => { this.m.x=e.clientX; this.m.y=e.clientY; };
        window.onmousedown = () => this.mDown=true; window.onmouseup = () => this.mDown=false;
        this.lStick = new Joy('stick-left'); this.rStick = new Joy('stick-right');
        let btn = document.getElementById('shockwave-btn');
        let trig = (e) => { e.preventDefault(); e.stopPropagation(); this.skill(); };
        btn.addEventListener('touchstart', trig, {passive:false}); btn.addEventListener('mousedown', trig);
    },
    move() {
        if(this.locked) return new Vec(0,0);
        let v = this.lStick.vec.copy();
        if(v.mag()===0) { if(this.keys['w'])v.y-=1; if(this.keys['s'])v.y+=1; if(this.keys['a'])v.x-=1; if(this.keys['d'])v.x+=1; if(v.mag()>0)v.norm(); }
        return v;
    },
    aim(pPos, cam) {
        if(this.locked) return null;
        if(this.rStick.active && this.rStick.vec.mag()>0.1) return this.rStick.vec.copy();
        if(this.isPC) return new Vec(this.m.x - (pPos.x-cam.x), this.m.y - (pPos.y-cam.y)).norm();
        return new Vec(0,0);
    },
    skill() {
        if(this.locked || !Game.p || !this.shockReady || Game.p.hp<=0 || Game.state!=='run') return;
        this.shockReady=false; Game.shockwave();
        let bar = document.getElementById('shock-cd'), pcBar = document.getElementById('pc-skill-fill');
        let start=Date.now(), dur=5000;
        let i = setInterval(()=>{
            if(Game.state==='paused') dur+=100;
            let pct = 1 - (Date.now()-start)/dur;
            if(pct<=0) { clearInterval(i); this.shockReady=true; if(bar)bar.style.height='0%'; if(pcBar)pcBar.style.width='100%'; }
            else { if(bar)bar.style.height=(pct*100)+'%'; if(pcBar)pcBar.style.width=((1-pct)*100)+'%'; }
        }, 50);
    }
};

/* ==========================================================================
   4. ENTITIES
   ========================================================================== */
class Ent { constructor(x, y, col, r) { this.pos=new Vec(x,y); this.col=col; this.r=r; this.dead=false; } }

class Bullet extends Ent {
    constructor(x, y, dir, dmg, spd, life, col, type) {
        super(x, y, col, type==='plasma'?12:5);
        this.vel=dir.mult(spd); this.dmg=dmg; this.life=life; this.type=type;
        this.pen = type==='plasma'?50:1; this.rico = false;
        if(type==='sniper') { this.r=3; this.vel.mult(1.5); }
    }
    upd() {
        this.pos.add(this.vel); this.life--; if(this.life<=0) this.dead=true;
        if(this.rico) {
            if(this.pos.x<0 || this.pos.x>CFG.w) { this.vel.x*=-1; this.pen--; }
            if(this.pos.y<0 || this.pos.y>CFG.w) { this.vel.y*=-1; this.pen--; }
            if(this.pen<=0) this.dead=true;
        }
    }
    draw(c) {
        c.fillStyle=this.col; c.shadowBlur=this.type==='plasma'?10:4; c.shadowColor=this.col; c.beginPath();
        if(this.type==='sniper') { c.moveTo(this.pos.x,this.pos.y); c.lineTo(this.pos.x-this.vel.x*3, this.pos.y-this.vel.y*3); c.lineWidth=3; c.strokeStyle=this.col; c.stroke(); }
        else c.arc(this.pos.x, this.pos.y, this.r, 0, 6.28);
        c.fill(); c.shadowBlur=0;
    }
}

class Player extends Ent {
    constructor() {
        super(CFG.w/2, CFG.w/2, CFG.colors.p, 15);
        this.hp=100; this.max=100; this.spd=6; this.dmg=15; this.rel=18; this.bSpd=16;
        this.count=1; this.pen=1; this.mag=100; this.rear=false; this.rico=false; this.bType='normal';
        this.side=false; this.shield=false;
        this.xp=0; this.next=50; this.lvl=1; this.ang=0; this.rTmr=0; this.iTmr=0;
        
        // Upgrade Caps
        this.ups = { multi: 0, rear: 0, spd: 0, reload: 0 };
    }
    upd() {
        let m = Input.move(); this.pos.add(m.mult(this.spd));
        this.pos.x = Math.max(0, Math.min(CFG.w, this.pos.x)); this.pos.y = Math.max(0, Math.min(CFG.w, this.pos.y));
        let a = Input.aim(this.pos, Game.cam);
        if(a) this.ang = Math.atan2(a.y, a.x); else if(m.mag()>0) this.ang = Math.atan2(m.y, m.x);
        
        if(this.rTmr>0) this.rTmr--; if(this.iTmr>0) this.iTmr--;
        
        let shoot = Input.mDown || (Input.rStick.active && Input.rStick.vec.mag()>0.2);
        if(shoot && this.rTmr<=0 && !Input.locked) {
            this.rTmr = this.rel;
            let start = this.ang - (0.15 * (this.count-1))/2;
            for(let i=0; i<this.count; i++) {
                let ang = start + i*0.15 + (Math.random()-0.5)*0.05;
                let b = new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(ang), Math.sin(ang)), this.dmg, this.bSpd, 60, this.col, this.bType);
                b.pen=this.pen; b.rico=this.rico; Game.bs.push(b);
            }
            if(this.rear) {
                // If rear is maxed, shoot 3
                let n = this.ups.rear >= 3 ? 3 : 1;
                let s = this.ang + 3.14 - (0.15 * (n-1))/2;
                for(let i=0; i<n; i++) {
                     let a = s + i*0.15;
                     let b = new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(a), Math.sin(a)), this.dmg, this.bSpd, 60, this.col, this.bType);
                     b.pen=this.pen; b.rico=this.rico; Game.bs.push(b);
                }
            }
            if(this.side) {
                let s1 = new Vec(Math.cos(this.ang+1.57), Math.sin(this.ang+1.57));
                let s2 = new Vec(Math.cos(this.ang-1.57), Math.sin(this.ang-1.57));
                Game.bs.push(new Bullet(this.pos.x, this.pos.y, s1, this.dmg*0.5, this.bSpd, 40, this.col, 'normal'));
                Game.bs.push(new Bullet(this.pos.x, this.pos.y, s2, this.dmg*0.5, this.bSpd, 40, this.col, 'normal'));
            }
            this.pos.sub(new Vec(Math.cos(this.ang), Math.sin(this.ang)).mult(3)); Game.shake(3);
        }
    }
    hit(v) {
        if(this.iTmr>0) return;
        if(this.shield) { this.shield=false; this.iTmr=60; Game.pop(this.pos, '#fff', 20); return; } 
        this.hp -= v; this.iTmr = 30; Game.shake(10);
        if(this.hp<=0) Game.over();
    }
    draw(c) {
        c.save(); c.translate(this.pos.x, this.pos.y); c.rotate(this.ang);
        c.strokeStyle = (this.iTmr>0 && Math.floor(Date.now()/50)%2==0) ? '#fff' : this.col;
        c.shadowBlur=10; c.shadowColor=this.col; c.lineWidth=3;
        c.beginPath(); c.moveTo(15,0); c.lineTo(-10,10); c.lineTo(-5,0); c.lineTo(-10,-10); c.closePath(); c.stroke();
        
        if(this.lvl>=10) { c.beginPath(); c.moveTo(-5,10); c.lineTo(-15,18); c.stroke(); c.beginPath(); c.moveTo(-5,-10); c.lineTo(-15,-18); c.stroke(); }
        if(this.lvl>=20) { c.fillStyle='#0ff'; c.beginPath(); c.arc(0,0,4,0,6.28); c.fill(); }
        if(this.shield) { c.beginPath(); c.arc(0,0,25,0,6.28); c.strokeStyle='#fff'; c.lineWidth=1; c.stroke(); }
        
        c.restore();
    }
}

class Ally extends Ent {
    constructor(type, pPos) {
        super(pPos.x, pPos.y, CFG.colors.ally, 15);
        this.type = type; this.hp = 200; this.maxHp = 200; this.reload = 40; this.tmr = 0; this.range = 300;
        this.angleOffset = Math.random() * 6.28;
        if(type==='drone') { this.speed=6; this.r=10; this.dmg=12; this.reload=15; this.range=250; } // Fast fire
        if(type==='turret') { this.hp=500; this.maxHp=500; this.speed=0; this.r=20; this.dmg=50; this.reload=90; this.range=500; } // Sniper
    }
    upd(p, es) {
        if(this.hp < this.maxHp && Math.random()<0.05) this.hp++;

        if(this.type === 'drone') {
            this.angleOffset += 0.08;
            let tx = p.pos.x + Math.cos(this.angleOffset) * 90;
            let ty = p.pos.y + Math.sin(this.angleOffset) * 90;
            this.pos.add(new Vec(tx - this.pos.x, ty - this.pos.y).mult(0.1));
        } else if(this.type === 'turret') {
            let d = Vec.dist(this.pos, p.pos);
            if(d > 350) { 
                let dir = p.pos.copy().sub(this.pos).norm().mult(3.5); 
                this.pos.add(dir);
            }
        }

        let target = null; let minD = this.range;
        es.forEach(e => {
            let d = Vec.dist(this.pos, e.pos);
            if (d < minD) { minD = d; target = e; }
        });

        if (target) {
            this.tmr++;
            if (this.tmr > this.reload) {
                this.tmr = 0;
                let aim = new Vec(target.pos.x - this.pos.x, target.pos.y - this.pos.y).norm();
                let bType = this.type === 'turret' ? 'sniper' : 'normal';
                Game.bs.push(new Bullet(this.pos.x, this.pos.y, aim, this.dmg, 12, 80, this.col, bType));
            }
        }
    }
    draw(c) {
        c.save(); c.translate(this.pos.x, this.pos.y); c.fillStyle = this.col;
        c.shadowBlur=5; c.shadowColor=this.col; c.beginPath();
        if(this.type==='drone'){ c.moveTo(10,0); c.lineTo(-8,6); c.lineTo(-8,-6); }
        else { c.rect(-10,-10,20,20); c.moveTo(0,-10); c.lineTo(0,-20); c.lineWidth=3; c.strokeStyle=this.col; c.stroke(); }
        c.fill();
        // HP Bar
        if(this.hp<this.maxHp) { c.fillStyle='#000'; c.fillRect(-12,-25,24,4); c.fillStyle='#0f0'; c.fillRect(-12,-25,24*(this.hp/this.maxHp),4); }
        c.restore();
    }
}

class Enemy extends Ent {
    constructor(type, pPos, isBoss, isMega) {
        let ang = Math.random()*6.28, d = isBoss?1200:900;
        super(pPos.x+Math.cos(ang)*d, pPos.y+Math.sin(ang)*d, '#f00', 15);
        this.pos.x = Math.max(100, Math.min(CFG.w-100, this.pos.x));
        this.pos.y = Math.max(100, Math.min(CFG.w-100, this.pos.y));
        this.type=type; this.boss=isBoss; this.mega=isMega; this.push=new Vec(0,0); this.tmr=0; this.flash=0;
        
        // --- AI STATE ---
        this.state = 'idle'; // idle, chase, attack, flee
        this.stateTmr = 0;
        this.targetPos = null;

        let m = Math.min(2.5, 1 + (Game.wave-1)*0.08); 
        this.scale = isMega ? 3 : 1; 

        if(isBoss) {
            let base = 1000 + Game.wave*500; if(isMega) base *= 5;
            this.hp = base; this.max = base; this.xp = 2000 * (isMega?5:1); this.r = 60 * (isMega?1.5:1); this.col = isMega ? CFG.colors.mega : CFG.colors.boss;
            this.spd = isMega ? 1.5 : 1; 
            this.name = (isMega ? "OMEGA " : "") + type.toUpperCase();
            this.rage = false; // Trigger at 50% HP
        } else {
            if(type==='basic') { this.hp=15*m; this.spd=1.8*m; this.col=CFG.colors.e_basic; this.xp=10; }
            if(type==='tank') { this.hp=50*m; this.spd=1.0*m; this.col=CFG.colors.e_tank; this.xp=30; this.r=25; }
            if(type==='sniper') { this.hp=20*m; this.spd=1.6*m; this.col=CFG.colors.e_sniper; this.xp=25; }
            if(type==='dasher') { this.hp=15*m; this.spd=4.0*m; this.col=CFG.colors.e_dasher; this.xp=15; this.r=12; }
            if(type==='spinner') { this.hp=35*m; this.spd=0.8*m; this.col=CFG.colors.e_spinner; this.xp=40; this.r=22; }
            this.max = this.hp;
        }
    }
    upd(p) {
        let dir = p.pos.copy().sub(this.pos).norm();
        let dist = Vec.dist(this.pos, p.pos);

        // Rage Check
        if(this.boss && !this.rage && this.hp < this.max*0.5) {
            this.rage = true; this.col = '#f00'; Game.shake(10); Nexus.log(this.name + " ENRAGED!");
        }

        if(this.boss) this.updBoss(p, dir, dist); else this.updMinion(p, dir, dist);
        
        // Basic Move (overridden by some states)
        if(this.state === 'chase' || this.state === 'idle') this.pos.add(dir.mult(this.spd * (this.rage?1.5:1)));
        
        this.pos.add(this.push); this.push.mult(0.9);
        if(this.flash>0) this.flash--;
    }
    
    updMinion(p, dir, dist) {
        this.state = 'chase'; // default
        
        if(this.type==='sniper') {
            if(dist < 300) { this.pos.sub(dir.mult(2)); this.state='flee'; } // Kite
            else if(dist < 550) { this.state='aim'; } // Stop
            
            if(this.state==='aim') {
                 this.tmr++;
                 if(this.tmr > 120) { // Predictive shot
                     this.tmr=0; 
                     let pred = p.pos.copy().add(p.pos.copy().sub(Game.lastPPos||p.pos).mult(20)); // Lead target
                     let aim = pred.sub(this.pos).norm();
                     Game.ebs.push(new Bullet(this.pos.x, this.pos.y, aim, 15, 8, 120, this.col, 'sniper')); 
                 }
            }
        }
        else if(this.type==='dasher') {
             if(this.state === 'idle' || this.state === 'chase') { 
                 this.tmr++;
                 if(this.tmr > 80) { this.state='dash'; this.tmr=0; this.targetPos=dir.copy(); }
                 this.pos.add(new Vec(Math.random()-0.5, Math.random()-0.5).mult(2)); // Shake
             } else if (this.state === 'dash') {
                 this.pos.add(this.targetPos.mult(10)); // ZOOM
                 this.tmr++;
                 if(this.tmr > 20) { this.state='idle'; this.tmr=0; }
             }
        }
        else if(this.type==='spinner') {
             this.tmr++; if(this.tmr>120) { this.tmr=0; for(let i=0;i<4;i++) Game.ebs.push(new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(i*1.57), Math.sin(i*1.57)), 8, 4, 100, this.col)); }
        }
    }

    updBoss(p, dir, dist) {
        this.tmr++;
        let rate = this.rage ? 0.7 : 1; 

        if (this.type==='titan') {
            // Tanky, follows slowly, shoots shotgun. Rage: Shoots 360
            if(this.rage && this.tmr % 200 === 0) {
                 for(let i=0; i<12; i++) Game.ebs.push(new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(i*0.52), Math.sin(i*0.52)), 10, 5, 100, '#fff'));
            } else if (this.tmr > 90*rate) { 
                this.tmr=0; 
                for(let i=-2;i<=2;i++) Game.ebs.push(new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(Math.atan2(dir.y,dir.x)+i*0.2), Math.sin(Math.atan2(dir.y,dir.x)+i*0.2)), 15, 6, 120, '#fff')); 
            }
        }
        else if (this.type==='streamer') {
            // Kites player. Rage: Double stream
            if(dist < 400) this.pos.sub(dir.mult(this.spd)); // Back away
            else if(dist > 600) this.pos.add(dir.mult(this.spd)); // Get closer
            
            if (this.tmr % (this.rage?4:8) === 0) {
                 let pred = p.pos.copy().add(p.pos.copy().sub(Game.lastPPos||p.pos).mult(10));
                 let aim = pred.sub(this.pos).norm();
                 Game.ebs.push(new Bullet(this.pos.x, this.pos.y, aim.add(new Vec((Math.random()-0.5)*0.1, (Math.random()-0.5)*0.1)), 8, 10, 80, '#0ff'));
            }
        }
        else if (this.type==='charger') {
            if(this.state==='idle' && this.tmr > 100*rate) { this.state='lock'; this.tmr=0; this.targetPos=dir.copy(); }
            else if(this.state==='lock') {
                 // Telegraph
                 this.tmr++;
                 if(this.tmr > 40) { this.state='dash'; this.tmr=0; }
            }
            else if(this.state==='dash') {
                this.pos.add(this.targetPos.mult(15));
                this.tmr++; if(this.tmr > 30) { this.state='idle'; this.tmr=0; }
            }
        }
        // ... (Nova and Summoner logic simplified for brevity but present in main loop via spawns)
        else if (this.type==='nova' && this.tmr > 120*rate) { this.tmr=0; for(let i=0;i<18;i++) Game.ebs.push(new Bullet(this.pos.x, this.pos.y, new Vec(Math.cos(i*0.35), Math.sin(i*0.35)), 12, 5, 150, '#ff0')); }
        else if (this.type==='summoner' && this.tmr > 200*rate) { this.tmr=0; let n = this.isMega ? 6 : 3; for(let i=0;i<n;i++) Game.es.push(new Enemy('dasher', this.pos, false, false)); }
    }

    hit(v, kb) {
        this.hp -= v; if(!this.boss) this.push.add(kb); this.flash=3;
        if(this.hp<=0) {
            this.dead=true; Game.pop(this.pos, this.col, this.boss?50:8);
            Game.dropXp(this.pos, this.xp); if(this.boss) Game.winBoss();
        }
    }
    draw(c) {
        c.save(); c.translate(this.pos.x, this.pos.y);
        c.strokeStyle = this.flash>0 ? '#fff' : this.col; c.lineWidth=3;
        c.shadowBlur = this.boss ? (this.mega ? 15 : 10) : 0; 
        c.shadowColor = this.col; c.beginPath();
        let s = this.scale; if(this.boss) c.scale(s, s);
        if(this.type==='basic') { c.moveTo(-10,-10); c.lineTo(10,-10); c.lineTo(0,15); }
        else if(this.type==='tank' || this.type==='titan') c.rect(-this.r,-this.r,this.r*2,this.r*2);
        else if(this.type==='sniper') { c.moveTo(0,-15); c.lineTo(10,0); c.lineTo(0,15); c.lineTo(-10,0); }
        else if(this.type==='dasher') { c.moveTo(0,-10); c.lineTo(8,10); c.lineTo(0,5); c.lineTo(-8,10); } 
        else c.arc(0,0,this.r,0,6.28);
        c.closePath(); c.stroke();
        
        // Charge telegraph
        if(this.type==='charger' && this.state==='lock') {
             c.beginPath(); c.moveTo(0,0); c.lineTo(this.targetPos.x*200, this.targetPos.y*200);
             c.strokeStyle = "rgba(255,0,0,0.5)"; c.setLineDash([5, 5]); c.stroke();
        }
        
        if(this.mega) { c.fillStyle = "rgba(255,255,255,0.2)"; c.fill(); }
        if(!this.boss && this.hp<this.max) { c.fillStyle='#f00'; c.fillRect(-15,-this.r-10,30*(this.hp/this.max),4); }
        c.restore();
    }
}

class Part extends Ent {
    constructor(x,y,c,s) { super(x,y,c,s); let a=Math.random()*6.28, sp=Math.random()*3+2; this.vel=new Vec(Math.cos(a)*sp, Math.sin(a)*sp); this.l=1.0; }
    upd(){this.pos.add(this.vel); this.l-=0.05;}
    draw(c){c.globalAlpha=Math.max(0,this.l); c.fillStyle=this.col; c.beginPath(); c.arc(this.pos.x,this.pos.y,this.r,0,6.28); c.fill(); c.globalAlpha=1;}
}

class XP extends Ent {
    constructor(x,y,v) { super(x,y,CFG.colors.xp,4); this.v=v; this.suck=false; }
    upd(p) {
        let d = Vec.dist(this.pos, p.pos);
        if(d < p.mag) this.suck=true;
        if(this.suck) { this.pos.add(p.pos.copy().sub(this.pos).norm().mult(12)); if(d<30) { this.dead=true; p.xp+=this.v; Game.checkLvl(); } }
    }
    draw(c) {
        c.fillStyle=this.suck?'#fff':this.col; c.shadowBlur=this.suck?5:0; c.shadowColor=this.col;
        c.beginPath(); c.arc(this.pos.x, this.pos.y, this.r, 0, 6.28); c.fill(); c.shadowBlur=0;
    }
}

const Game = {
    c: document.getElementById('gameCanvas'), ctx: document.getElementById('gameCanvas').getContext('2d'),
    p: null, es: [], bs: [], ebs: [], ps: [], xps: [], xpOrbs: [], allies: [], floatingTexts: [],
    cam: new Vec(0,0), shakeTime: 0, state: 'menu', wave: 1, wTmr: 0, score: 0, boss: null,
    hi: parseInt(localStorage.getItem('nv_hi')) || 0,
    last: 0, acc: 0, step: 1000/60, introT: 0, nextBoss: null, lastPPos: null,

    ups: [
        {id:'m', n:'Tri-Shot', d:'+1 Projectile', max:5}, {id:'r', n:'Rear Guard', d:'Back Shot', max:3},
        {id:'mg', n:'Magnet', d:'+Range', max:5}, {id:'d', n:'Power', d:'+25% Dmg', max:99},
        {id:'s', n:'Speed', d:'+15% Spd', max:5}, {id:'l', n:'Reload', d:'-15% CD', max:5},
        {id:'h', n:'Repair', d:'Heal + MaxHP', max:99}, {id:'sd', n:'Side Guns', d:'Lateral Fire', max:1},
        {id:'sh', n:'Shield', d:'Block 1 Hit', max:1}, {id:'dr', n:'Drone', d:'Orbit Ally', max:3}, {id:'tr', n:'Turret', d:'Fixed Ally', max:2}
    ],
    bossUps: [
        {id:'rico', n:'Ricochet', d:'Bouncing Shots', r:'legendary'}, 
        {id:'plas', n:'Plasma', d:'Huge Piercing', r:'legendary'},
        {id:'rail', n:'Railgun', d:'Instant Hit', r:'legendary'}
    ],

    init() {
        this.resize(); window.onresize=()=>this.resize(); Input.init();
        document.getElementById('high-score').innerText = this.hi;
        ['btn-start', 'btn-restart'].forEach(id => document.getElementById(id).onclick = () => this.start());
        document.getElementById('btn-full').onclick = () => document.documentElement.requestFullscreen().catch(()=>{});
        document.getElementById('pause-btn').onclick = () => this.pause();
        document.getElementById('btn-resume').onclick = () => this.pause();
        document.getElementById('btn-menu').onclick = () => { location.reload(); };
        document.getElementById('btn-menu-over').onclick = () => { location.reload(); };
        requestAnimationFrame(t => this.loop(t));
    },
    resize() { this.c.width=window.innerWidth; this.c.height=window.innerHeight; },

    start() {
        this.p = new Player(); 
        this.es=[]; this.bs=[]; this.ebs=[]; this.ps=[]; this.xps=[]; this.xpOrbs=[]; this.allies=[]; this.floatingTexts=[];
        this.score=0; this.wave=1; this.wTmr=0; this.boss=null; this.state='run';
        this.cam = new Vec(this.p.pos.x - this.c.width/2, this.p.pos.y - this.c.height/2);
        Input.locked = true; setTimeout(()=>Input.locked=false, 500);
        document.querySelectorAll('.modal').forEach(e=>e.classList.add('hidden'));
        document.getElementById('ui-layer').classList.remove('hidden');
        document.getElementById('boss-hud').style.display='none';
        Nexus.log("SYSTEM ONLINE. OMEGA 7.3");
    },

    pause() {
        if(this.state==='run') { this.state='paused'; document.getElementById('pause-screen').classList.remove('hidden'); }
        else if(this.state==='paused' && document.getElementById('upgrade-screen').classList.contains('hidden')) { this.state='run'; document.getElementById('pause-screen').classList.add('hidden'); }
    },

    spawn() {
        if(this.boss || this.state==='intro') return;
        if(this.es.length > 5 + this.wave) return; 
        let pool=['basic']; if(this.wave>2) pool.push('tank'); if(this.wave>4) pool.push('dasher'); 
        if(this.wave>6) pool.push('sniper'); if(this.wave>8) pool.push('spinner');
        this.es.push(new Enemy(pool[Math.floor(Math.random()*pool.length)], this.p.pos, false));
    },

    spawnBoss(mega) {
        this.state = 'intro'; this.introT = 180;
        this.es = this.es.filter(e => Vec.dist(e.pos, this.p.pos) > 1200);
        let types = ['titan', 'streamer', 'nova', 'summoner', 'charger'];
        let type = types[Math.floor(Math.random()*types.length)];
        
        let ang = Math.random()*6.28, dist = 800;
        let bx = Math.max(200, Math.min(CFG.w-200, this.p.pos.x + Math.cos(ang)*dist));
        let by = Math.max(200, Math.min(CFG.w-200, this.p.pos.y + Math.sin(ang)*dist));
        this.nextBoss = { t:type, x:bx, y:by, m:mega };
        
        document.getElementById('warning-overlay').style.display = 'flex';
        document.getElementById('warning-text').innerText = mega ? "OMEGA SIGNAL" : "ANOMALY";
        Nexus.bossIntro(type, mega);
    },

    realSpawn() {
        document.getElementById('warning-overlay').style.display = 'none';
        let d = this.nextBoss;
        let b = new Enemy(d.t, {x:0,y:0}, true, d.m);
        b.pos.x=d.x; b.pos.y=d.y;
        this.es.push(b); this.boss = b;
        let hud = document.getElementById('boss-hud'); hud.style.display='flex';
        if(d.m) hud.classList.add('mega'); else hud.classList.remove('mega');
        document.getElementById('boss-name').innerText = b.name;
        this.shake(40); this.pop(b.pos, d.m?'#fff':'#f0f', 80);
    },

    winBoss() { this.boss=null; document.getElementById('boss-hud').style.display='none'; this.menu(true); },
    pop(p, c, n) { for(let i=0;i<n;i++) this.ps.push(new Part(p.x, p.y, c, Math.random()*5)); },
    dropXp(p, v) { this.xpOrbs.push(new XP(p.x, p.y, v)); this.score+=v; },
    checkLvl() { if(this.p.xp>=this.p.next) { this.p.xp-=this.p.next; this.p.lvl++; this.p.next*=1.3; this.menu(false); } },
    shake(v) { this.shakeTime = v; },

    shockwave() {
        this.shake(20); this.pop(this.p.pos, '#fff', 50);
        this.es.forEach(e => { if(!e.boss && Vec.dist(e.pos, this.p.pos)<400) { e.push.add(e.pos.copy().sub(this.p.pos).norm().mult(30)); e.hit(20, new Vec(0,0)); }});
        this.ebs = [];
    },

    menu(boss) {
        this.state='paused';
        let el = document.getElementById('upgrade-screen'), list = document.getElementById('cards-wrapper');
        list.innerHTML=''; el.classList.remove('hidden');
        let pool = boss ? this.bossUps : this.ups;
        
        // Filter capped upgrades
        let valid = pool.filter(u => {
            if(u.max) {
                 if(u.id === 'dr') return this.allies.filter(a=>a.type==='drone').length < u.max;
                 if(u.id === 'tr') return this.allies.filter(a=>a.type==='turret').length < u.max;
                 return (this.p.ups[u.id] || 0) < u.max;
            }
            return true;
        });

        let opts = [...valid].sort(()=>0.5-Math.random()).slice(0,3);
        
        opts.forEach(u => {
            let d = document.createElement('div'); d.className = `card ${u.r||'common'}`;
            d.innerHTML = `<h3>${u.n}</h3><div class="icon">★</div><p>${u.d}</p><div class="rarity">${u.r||'common'}</div>`;
            d.onclick = () => {
                let p = this.p;
                if(u.max && p.ups[u.id] !== undefined) p.ups[u.id]++;

                if(u.id=='m') p.count++; if(u.id=='r') p.rear=true; if(u.id=='mg') p.mag+=100;
                if(u.id=='d') p.dmg*=1.2; if(u.id=='s') p.spd*=1.1; if(u.id=='l') p.rel*=0.85;
                if(u.id=='h') { p.max*=1.3; p.hp=p.max; } if(u.id=='sd') p.side=true;
                if(u.id=='sh') p.shield=true;
                if(u.id=='dr') this.allies.push(new Ally('drone', p.pos));
                if(u.id=='tr') this.allies.push(new Ally('turret', p.pos));
                // Legendary
                if(u.id=='rico') p.rico=true; if(u.id=='plas') p.bType='plasma'; if(u.id=='rail') p.bType='sniper';
                
                el.classList.add('hidden'); this.state='run';
            };
            list.appendChild(d);
        });
    },

    update(dt) {
        if(this.state==='intro') {
            this.introT--;
            let tx = this.nextBoss.x - this.c.width/2, ty = this.nextBoss.y - this.c.height/2;
            this.cam.x += (tx - this.cam.x) * 0.05; this.cam.y += (ty - this.cam.y) * 0.05;
            if(this.introT<=0) { this.state='run'; this.realSpawn(); }
            return;
        }
        if(this.state!=='run') return;

        this.lastPPos = this.p.pos.copy(); 

        if(!this.boss) {
            this.wTmr++;
            if(this.wTmr > 1200) { 
                this.wave++; this.wTmr=0; 
                // Mega every 20 waves, Normal every 5
                if(this.wave%20===0) this.spawnBoss(true); 
                else if(this.wave%5===0) this.spawnBoss(false);
            }
            if(Math.random() < 0.02) this.spawn();
        }

        this.p.upd();
        this.bs.forEach(b=>b.upd()); this.bs=this.bs.filter(b=>!b.dead);
        this.ebs.forEach(b=>b.upd()); this.ebs=this.ebs.filter(b=>!b.dead);
        this.es.forEach(e=>e.upd(this.p)); this.es=this.es.filter(e=>!e.dead);
        this.ps.forEach(p=>p.upd()); this.ps=this.ps.filter(p=>p.life>0);
        this.xpOrbs.forEach(x=>x.upd(this.p)); this.xpOrbs=this.xpOrbs.filter(x=>!x.dead);
        this.allies.forEach(a=>a.upd(this.p, this.es)); this.allies=this.allies.filter(a=>!a.dead);

        // Collisions
        this.es.forEach(e => {
            if(Vec.dist(this.p.pos, e.pos) < this.p.r+e.r) { this.p.hit(5); if(!e.boss) e.push.add(e.pos.copy().sub(this.p.pos).norm().mult(10)); }
            this.bs.forEach(b => {
                if(Vec.dist(b.pos, e.pos) < e.r+b.r) {
                    e.hit(b.dmg, b.vel.copy().norm().mult(5));
                    if(!b.rico && b.type!=='plasma') b.dead=true;
                    if(b.pen && b.pen>0) { b.pen--; if(b.pen<=0) b.dead=true; }
                }
            });
        });
        this.ebs.forEach(b => { if(Vec.dist(b.pos, this.p.pos) < this.p.r+b.r) { this.p.hit(10); b.dead=true; } });

        let tx = Math.max(0, Math.min(CFG.w-this.c.width, this.p.pos.x - this.c.width/2));
        let ty = Math.max(0, Math.min(CFG.w-this.c.height, this.p.pos.y - this.c.height/2));
        this.cam.x += (tx - this.cam.x) * 0.1; this.cam.y += (ty - this.cam.y) * 0.1;
        if(this.shakeTime>0) { this.cam.x+=(Math.random()-0.5)*this.shakeTime; this.cam.y+=(Math.random()-0.5)*this.shakeTime; this.shakeTime*=0.9; }

        document.getElementById('score-val').innerText = Math.floor(this.score);
        document.getElementById('wave-val').innerText = "WAVE " + this.wave;
        document.getElementById('xp-bar').style.width = (this.p.xp/this.p.next)*100 + "%";
        document.getElementById('hp-bar').style.width = (this.p.hp/this.p.max)*100 + "%";
        if(this.boss) document.getElementById('boss-hp-fill').style.width = (this.boss.hp/this.boss.max)*100 + "%";
    },

    draw() {
        let c = this.ctx;
        c.fillStyle = CFG.colors.bg; c.fillRect(0,0,this.c.width,this.c.height);
        c.save(); c.translate(-this.cam.x, -this.cam.y);
        
        c.strokeStyle = CFG.colors.grid; c.lineWidth = 2; c.beginPath();
        let cx = this.cam.x, cy = this.cam.y, cw = this.c.width, ch = this.c.height;
        let sx = Math.floor(cx/100)*100, sy = Math.floor(cy/100)*100;
        for(let x=sx; x<cx+cw+100; x+=100) if(x<=CFG.w){c.moveTo(x,Math.max(0,cy));c.lineTo(x,Math.min(CFG.w,cy+ch));}
        for(let y=sy; y<cy+ch+100; y+=100) if(y<=CFG.w){c.moveTo(Math.max(0,cx),y);c.lineTo(Math.min(CFG.w,cx+cw),y);}
        c.stroke(); c.strokeStyle = '#f00'; c.lineWidth = 5; c.strokeRect(0,0,CFG.w,CFG.w);
        
        if(this.state==='intro' && this.nextBoss) {
            c.save(); c.translate(this.nextBoss.x, this.nextBoss.y);
            c.strokeStyle = this.nextBoss.m ? '#fff' : '#f0f'; c.lineWidth=5;
            let s = 1 + Math.sin(Date.now()/100)*0.2; c.scale(s,s);
            c.beginPath(); c.arc(0,0,100,0,6.28); c.stroke();
            c.restore();
        }

        this.xpOrbs.forEach(e=>e.draw(c));
        this.bs.forEach(e=>e.draw(c));
        this.ebs.forEach(e=>e.draw(c));
        this.allies.forEach(e=>e.draw(c)); 
        this.es.forEach(e=>e.draw(c));
        if(this.p && this.state!=='over') this.p.draw(c);
        this.ps.forEach(e=>e.draw(c));
        
        c.restore();
    },

    loop(now) {
        if(!this.last) this.last=now;
        let dt = now - this.last; this.last = now;
        if(dt > 100) dt = 100; // Cap
        this.acc += dt;
        while(this.acc >= this.step) { this.update(); this.acc -= this.step; }
        this.draw();
        requestAnimationFrame(t => this.loop(t));
    },

    over() {
        this.state = 'over';
        if(this.score > this.hi) { this.hi = Math.floor(this.score); localStorage.setItem('nv_hi', this.hi); }
        document.getElementById('final-stats').innerText = `SCORE: ${Math.floor(this.score)} | WAVE: ${this.wave}`;
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('ui-layer').classList.add('hidden');
    }
};

Game.init();

})();
</script>
</body>
</html>